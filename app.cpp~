/**
 ******************************************************************************
 ** ï¿½tï¿½@ï¿½Cï¿½ï¿½ï¿½ï¿½ : app.c
 **
 ** ï¿½Tï¿½v : 2ï¿½Ö“|ï¿½ï¿½ï¿½Uï¿½qï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½gï¿½ï¿½ï¿½[ï¿½Xï¿½ï¿½ï¿½{ï¿½bï¿½gï¿½ï¿½TOPPERS/HRP2ï¿½pCï¿½Tï¿½ï¿½ï¿½vï¿½ï¿½ï¿½vï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½ï¿½
 **
 ** ï¿½ï¿½ï¿½L : sample_c4 (sample_c3ï¿½ï¿½Bluetoothï¿½ÊMï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½gï¿½Xï¿½^ï¿½[ï¿½gï¿½@ï¿½\ï¿½ï¿½Ç‰ï¿½)
 ******************************************************************************
 **/

#include "ev3api.h"
#include "app.h"
#if defined(BUILD_MODULE)
#include "module_cfg.h"
#else
#include "kernel_cfg.h"
#endif

#include "ActionController.h"

// using namespace ev3api;

#define DEBUG

#ifdef DEBUG
#define _debug(x) (x)
#else
#define _debug(x)
#endif

static int      bt_cmd = 0;
static FILE     *bt = NULL;


void main_task(intptr_t unused)
{
    AC_pre();

    // Bluetoothã§ã®ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚ªãƒ¼ãƒ—ãƒ³ã™ã‚‹
    bt = ev3_serial_open_file(EV3_SERIAL_BT);
    assert(bt != NULL);

    // Bluetoothå—ä¿¡ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œ
    act_tsk(BT_TASK);
   
    // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
    while(1)
    {
        AC_main_process();
        tslp_tsk(LOOP_INTERVAL); /* 4msecï¿½ï¿½ï¿½ï¿½ï¿½Nï¿½ï¿½ */
    }

    // Bluetoothç”¨ã‚¿ã‚¹ã‚¯ã‚’çµ‚äº†
    ter_tsk(BT_TASK);
    fclose(bt);

    // ActionControllerã®çµ‚äº†å‡¦ç†
    AC_post();

    // è‡ªã‚¿ã‚¹ã‚¯ã®çµ‚äº†
    ext_tsk();
}



//*****************************************************************************
// ï¿½Öï¿½ï¿½ï¿½ : bt_task
// ï¿½ï¿½ï¿½ï¿½ : unused
// ï¿½Ô‚ï¿½l : ï¿½È‚ï¿½
// ï¿½Tï¿½v : Bluetoothï¿½ÊMï¿½É‚ï¿½éƒŠï¿½ï¿½ï¿½[ï¿½gï¿½Xï¿½^ï¿½[ï¿½gï¿½B Tera Termï¿½È‚Ç‚Ìƒ^ï¿½[ï¿½~ï¿½iï¿½ï¿½ï¿½\ï¿½tï¿½gï¿½ï¿½ï¿½ï¿½A
//       ASCIIï¿½Rï¿½[ï¿½hï¿½ï¿½1ï¿½ğ‘—Mï¿½ï¿½ï¿½ï¿½ÆAï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½gï¿½Xï¿½^ï¿½[ï¿½gï¿½ï¿½ï¿½ï¿½B
//*****************************************************************************
void bt_task(intptr_t unused)
{
    while(1)
    {
        uint8_t c = fgetc(bt);
        switch(c)
        {
        case BT_CMD_START:
            bt_cmd = BT_CMD_START;
            break;

        case BT_CMD_FINISH:
            bt_cmd = BT_CMD_FINISH;
            break;

        default:
            break;
        }
        fputc(c, bt);
    }
}
